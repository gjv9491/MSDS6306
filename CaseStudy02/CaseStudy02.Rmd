---
title: "Case Study 02"
author: "contributed by Ramesh and gino"
date: "December 08, 2016"
output: 
  html_document:
    keep_md: true
---
## Introduction

Case Study 02, final case study.    

* installation and loading of necessary packages              
* R version        
<br>

```{r setup, include=TRUE, message=FALSE, echo=TRUE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "~/git/MSDS6306/CaseStudy02/Analysis/Data")
require(tseries)
require(ggplot2)
require(sqldf)
require(lubridate)
require(tcltk)
sessionInfo()
```

<br>
<br>

### Question 1                                                        
##### Create the X matrix and print it from SAS, R, and Python.                            
<br>

#### SAS Code


```{sas sasq01, eval=FALSE, cache=TRUE, echo=TRUE}
data mylib.Xmatrix;
input x0 x1 x2 x3;
datalines;
4 5 1 2
1 0 3 5
2 1 8 2
;
run;
quit;

Proc IML;
use mylib.Xmatrix;
read all;
x = x0 || x1 || x2 || x3;
print x;
run;
quit;
```          
![alt text](https://github.com/gjv9491/MSDS6306/blob/casestudy02/CaseStudy02/CaseStudy02_files/figure-html/SASQ01-1.png "SAS output")
<br>

#### R Code


```{r rq01, eval=TRUE, cache=TRUE, echo=TRUE}
new_vector <- c(4,5,1,2,1,0,3,5,2,1,8,2)
X <- matrix(new_vector, ncol=4, nrow=3, byrow=TRUE)
X
```                                 
<br>

#### Python Code


```{python pyq01, eval=FALSE, cache=TRUE, echo=TRUE}
import numpy as np

new_array = np.array([4,5,1,2,1,0,3,5,2,1,8,2])
new_matrix = np.matrix(new_array)
X = new_matrix.reshape(3,4)
print(X)
```                                     
![alt text](https://github.com/gjv9491/MSDS6306/blob/casestudy02/CaseStudy02/CaseStudy02_files/figure-html/PYTHONQ01-1.png "Python output")
<br>                  
<br>                

### Question 2                                                        
##### Please do the following with your assigned stock. "ADP" 
<br>

#### Download "ADP" data.
```{r radp01, eval=TRUE, cache=TRUE, echo=TRUE}
ADP_data <- get.hist.quote('ADP',quote="Close")
``` 
<br>

#### Calculate log returns.                        
```{r radp02, eval=TRUE, cache=TRUE, echo=TRUE}
ADP_return <- log(lag(ADP_data)) - log(ADP_data)
ADP_volatility <- sd(ADP_return) * sqrt(250) * 100
``` 
<br>

#### Calculate volatility measure.
```{r radp03, eval=TRUE, cache=TRUE, echo=TRUE}
getVol <- function(d, log_returns){
  var = 0
  lam = 0
  varlist <- c()

  for (r in log_returns) {
    lam = lam*(1 - 1/d) + 1
    var = (1 - 1/lam)*var + (1/lam)*r^2
    varlist <- c(varlist, var)
  }
  sqrt(varlist)
}
``` 
<br>

#### Calculate volatility over entire length of series for various three different decay factors.
```{r radp04, eval=TRUE, cache=TRUE, echo=TRUE}
volest <- getVol(10,ADP_return)
volest2 <- getVol(30,ADP_return)
volest3 <- getVol(100,ADP_return)

```                    
<br>                

#### Plot the results, overlaying the volatility curves on the data, just as was done in the S&P example.              
```{r radp05, eval=TRUE, cache=FALSE, echo=TRUE}
plot(volest, type="l", col="green", main="Volatility curves for ADP stock", ylab = "Volitality Estimate")
lines(volest2,type="l",col="red")
lines(volest3, type = "l", col="blue")
```                    
<br>  
<br>

### Question 3     
##### The built-in data set called Orange in R is about the growth of orange trees. The Orange data frame has 3 columns of records of the growth of orange trees.                      
<br>

#### a) Calculate the mean and the median of the trunk circumferences for different size of the trees. (Tree)                  
```{r tree01, eval=TRUE, cache=TRUE, echo=TRUE}
data("Orange")
head(Orange)
str(Orange)
summary(Orange)

#Mean of circumference by Tree size
orange_mean <- tapply(Orange$circumference,Orange$Tree,mean)
orange_mean[order(names(orange_mean))]

#Median of circumference by Tree size
orange_median <- tapply(Orange$circumference,Orange$Tree,median)
orange_median[order(names(orange_median))]

``` 
<br>         

#### b) Make a scatter plot of the trunk circumferences against the age of the tree. Use different plotting symbols for different size of trees.                   
```{r tree02, eval=TRUE, cache=TRUE, echo=TRUE}
is.numeric(Orange$Tree)
is.factor(Orange$Tree)
Orange$order.tree <- as.numeric(as.character(Orange$Tree))

ggplot(data=Orange, aes(x=Orange$circumference, y=Orange$age)) + 
  geom_point(aes(shape = reorder(Orange$Tree,Orange$order.tree)), size=4) +
  scale_shape(name="Tree Types", solid = FALSE) +
  ggtitle("Age vs. Circumference") + xlab("Circumference") + ylab("Age") 

``` 
<br>                  

#### c) Display the trunk circumferences on a comparative boxplot against tree. Be sure you order the boxplots in the increasing order of maximum diameter.            
```{r tree03, eval=TRUE, cache=TRUE, echo=TRUE}
  ggplot(Orange, aes(reorder(Orange$Tree,Orange$circumference) , Orange$circumference, fill = reorder(Orange$Tree,Orange$order.tree))) +  
 geom_boxplot() +
    guides(fill = guide_legend(title = "Tree Types"))+
  ggtitle("Tree vs circumference") +
  xlab("Tree") +  ylab("Circumference")
``` 
<br>  
<br>

### Question 4     
##### Download “Temp” data set                   
<br>

##### Clean TEMP.csv data to get "Date" into one consistant format
```{r temp01, eval=TRUE, cache=TRUE, echo=TRUE}
temp_data <- read.csv("TEMP.csv",header=TRUE)
str(temp_data)

#Any data set that is "NA" has been removed across the board
temp_data <- temp_data[complete.cases(temp_data),]

temp_data$date.clean <- as.Date(temp_data$Date, format = "%Y-%m-%d")
temp_data.sub <- subset(temp_data,is.na(temp_data$date.clean))
temp_data.sub02 <- subset(temp_data,!is.na(temp_data$date.clean))

temp_data.sub$date.clean <- format(dmy(temp_data.sub$Date),"%Y-%m-%d")
temp_data.sub$date.clean <- as.Date(temp_data.sub$date.clean, format = "%Y-%m-%d")



final_temp_data <- rbind(temp_data.sub,temp_data.sub02)

write.csv(final_temp_data,"final_temp_data.csv")

remove(list = ls())

final_temp_data <- read.csv("final_temp_data.csv",header=TRUE)
str(final_temp_data)
```                     
<br>

##### (i) Find the difference between the maximum and the minimum monthly average temperatures for each country and report/visualize top 20 countries with the maximum differences for the period since 1900. 
```{r temp02, eval=TRUE, cache=TRUE, echo=TRUE}
#romve unwanted rows
final_temp_data <- subset(final_temp_data,select = c("Date","Monthly.AverageTemp","Monthly.AverageTemp.Uncertainty","Country","date.clean"))
final_temp_data$date.clean <-  as.Date(final_temp_data$date.clean)
final_temp_data$date.month <- format(as.Date(final_temp_data$date.clean), "%d")
final_temp_data$date.year <- format(as.Date(final_temp_data$date.clean), "%Y")
final_temp_data02 <- subset(final_temp_data,final_temp_data$date.clean > '1900-12-31')
temp_country <- sqldf("SELECT Country, [date.month] AS Month, (max([Monthly.AverageTemp])-min([Monthly.AverageTemp])) AS TempDiff FROM final_temp_data02 Group by Country, [date.month]")
top20_max_temp <- sqldf("Select src.Country, src.MaxTempDiff From (SELECT Country, max(TempDiff) MaxTempDiff FROM temp_country group by Country) src order by src.MaxTempdiff DESC LIMIT 20")
max_country_temp <- sqldf("Select  tc.Country, tc.Month, tc.TempDiff FROM top20_max_temp as mt inner join temp_country as tc on mt.country = tc.country ")
``` 
<br>

```{r temp03, eval=TRUE, cache=TRUE, echo=TRUE}
ggplot(data=max_country_temp, aes(x=max_country_temp$Month, y=max_country_temp$TempDiff , colour =Country)) +
  geom_density(alpha=0.1,position = "stack")+
  ggtitle("20 Countries w/ Highest Temp. Diff. per month") + xlab("Month") + ylab("Temp. Diff. between max and min")

remove(temp_country)
remove(top20_max_temp)
remove(max_country_temp)
``` 
<br>

##### (ii) Select a subset of data called “UStemp” where US land temperatures from 01/01/1990 in Temp data. Use UStemp dataset to answer the followings.         
<br>

```{r temp04, eval=TRUE, cache=TRUE, echo=TRUE}
ustemp <- subset(final_temp_data02,(final_temp_data02$Country=="United States") & (final_temp_data02$date.clean > '1990-01-01'))
getfahrenheit <- function(Celsius){
  return(round(((Celsius*(9/5)) + 32), digits = 3))
  }
``` 
<br>

##### a) Create a new column to display the monthly average land temperatures in Fahrenheit (°F).
```{r temp05, eval=TRUE, cache=TRUE, echo=TRUE}
ustemp$fahrenheit <- getfahrenheit(ustemp$Monthly.AverageTemp)
str(ustemp)
``` 
<br>

##### b) Calculate average land temperature by year and plot it. The original file has the average land temperature by month.                         
```{r temp06, eval=TRUE, cache=TRUE, echo=TRUE}
usa_temp_year <- sqldf("SELECT Country, [date.year], avg([Monthly.AverageTemp]) as avgtemp, avg(fahrenheit) as avgtempinF FROM ustemp Group by [date.year]")

ggplot(usa_temp_year, aes(x=usa_temp_year$date.year, y=usa_temp_year$avgtemp, color=avgtemp) ) +
  geom_point()+
  ggtitle(" Avg. Temp. in U.S.A every year") + xlab("Year") + ylab("Average Temperature") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```     
<br>





